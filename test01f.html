<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TEST-foto-TORCH2</title>
        <style>
            h1 {margin-top: 0.5rem; color: grey;}
            a {font-size:1.2rem;}
        </style>
    </head>
    <body>
        <a href="javascript: history.go(-1)">Volver a MENU</a>
        <br><br>
        <h1>
            TEST foto TORCH37
        </h1>

        <br>
        <!--<button id="but" style="font-size : 18px; width: 200px; height: 40px;">Ver LOG</button>-->
        <a id="but" class="btn btn-lg btn-success py-1" href="#" role="button">Ver LOG</a>
        <!-- autoPlay + playsInline TRUE es obligatorio para que funcione en iOS-->
        <div>
            <video width="270px" height= "480px" id="vid" autoPlay="true" muted="true" playsInline="true"></video>
        </div>

        <script>

            function restart(idDevice){
                if (window.stream) {
                    window.stream.getTracks().forEach(track => {
                        track.stop();
                    });
                }
                let videoBis = document.getElementById("vid");
                // Accessing the user camera and video.
                navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: {deviceId: {exact: idDevice}}
                })
                .then((streamBis) => {
                    // Changing the source of video to current stream.
                    videoBis.srcObject = streamBis;
                    videoBis.addEventListener("loadedmetadata", () => {
                        videoBis.play();
                    });
                    const videoTrack = streamBis.getVideoTracks()[0];
                    videoTrack.applyConstraints({torch: true})
                        .then(() => console.log(videoTrack.getSettings().torch));

                }).catch(alert);
            }


            document.addEventListener("DOMContentLoaded", () => {

                let but = document.getElementById("but");
                let video = document.getElementById("vid");

                let idSelected;

                //but.addEventListener("click", () => {tomaFoto();});
                but.onclick = function(e) {
                    e.preventDefault();
                    restart(idSelected);
                    //alert('test');
                };


                // Accessing the user camera and video.
                navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: {deviceId: undefined}
                })
                .then((stream) => {
                    // Changing the source of video to current stream.
                    video.srcObject = stream;
                    video.addEventListener("loadedmetadata", () => {
                        video.play();

                        navigator.mediaDevices.enumerateDevices()
                        .then((devices) => {
                            devices.forEach((device) => {
                                //console.log(`${device.kind}: ${device.label} id = ${device.deviceId}`);
                                if (device.kind === 'videoinput'){
                                    if ((device.label.includes('0,'))||
                                    (device.label === 'CÃ¡mara trasera')||
                                    (device.label === 'Back Camera')){
                                        idSelected = device.deviceId;
                                        //restart(idSelected);
                                    }
                                }
                            });
                        })
                        .catch((err) => {
                            alert(err.message);
                        });

                    });
                }).catch(alert);

            });

        </script>

    </body>
</html>